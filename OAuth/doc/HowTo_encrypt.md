# HowTo: Encrypt data 

Encryption is a key way to protect information from intruders, not only by transferring it over a network without risk, but also by guaranteeing data integrity. There are many ciphers, but we will consider one of the most reliable and popular - **AES-GCM**.
`AES-GCM` is an authenticated encryption mode that uses the AES block cipher in counter mode with a polynomial MAC based on Galois field multiplication.
  
AES stands for `Advanced Encryption Standard` and is a symmetric block encryption algorithm. Symmetric encryption means that the key used for encryption and decryption is identical. The public key used for encrypted data, and only someone with the private key can read the encrypted data. 

To encrypt data `getEncryptedData()` is use.

```javascript
async function getEncryptedData(data) {          
    const iv = crypto.getRandomValues(new Uint8Array(12)); 
    const cipher = await encryptAESGCM(SECRET, iv, data);
    return uint8ToHexString(iv) + '.' + toBase64url(btoa(cipher));
}
```
 To encrypt data use:
  * `iv` Initial vector() - random or pseudo-random sequence of characters that is added to the encryption key to improve its security. The initialization vector does not require encryption and is usually passed along with the cryptographic key. The result of the encryption is a string containing initial vector and encrypted data divided into `.`.
  * `SECRET` the secret key used to decrypt the data.
  * `data` data to be encrypted.
       
  To create a cipher, use the `encryptAESGCM()` function.  

```javascript
let cachedPassHash;

async function passHash(pw) {
    return cachedPassHash || (cachedPassHash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw)));
}

async function makeKeyAESGCM(password, iv) {
    const pwHash = await passHash(password);    //small value generated by a hash function from a whole message
    const alg = { name: 'AES-GCM', iv: iv };    // specify algorithm to use
    return await crypto.subtle.importKey('raw', pwHash, alg, false, ['decrypt', 'encrypt']);  //make crypto key
}

async function encryptAESGCM(password, iv, plaintext) {
    const key = await makeKeyAESGCM(password, iv);            //[1]
    const ptUint8 = new TextEncoder().encode(plaintext);      //[2]
    const ctBuffer = await crypto.subtle.encrypt({ name: key.algorithm.name, iv: iv }, key, ptUint8);//[3]
    const ctArray = Array.from(new Uint8Array(ctBuffer));     //[4]
    return ctArray.map(byte => String.fromCharCode(byte)).join('');   // ciphertext as string
}
```
  1. The function creates the cipher key (not to be confused with the secret key). Creating and managing keys is an important part of the ciphering process. The key should be kept secret from anyone who should not decrypt your data.
  2. The data to be encrypted are converted to _UTF-8_ format.
  3. Using the Crypto API, data are encrypted.
  4. In order for a user to receive data in String format, they must be converted back to Uint8Array and then to string.


Result of encryption is a string which contains `iv` converted into  hexString and cipher which is encoded by `btoa()` and converted into Base64.

  ```javascript
function toBase64url(base64str) {
  return base64str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function uint8ToHexString(ar) {
  return Array.from(ar).map(b => ('00' + b.toString(16)).slice(-2)).join('');
}
```
The `btoa()` method is for encoding a string specified as a parameter in the ACSII string base-64, which will be represented by 64 characters: "A-Z", "a-z", "0-9", "+", "/" and "=". Base64 encoding can be used to visually hide data from the user, to transfer information, etc. The principle of the method is that it first converts a string into a sequence of bits, which are then converted into an encoded string based on the base-64 scheme.

To reduce the risk of data tampering it is important to follow a few tips:
* Each encryption operation performed with a given key must be unique. 
* Never use iv with the same key twice.
* Do not reuse initialization vectors. 

## Reference
* [Wikipedia: Galois/Counter Mode](https://en.wikipedia.org/wiki/Galois/Counter_Mode)
* [MDN: importKey](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey)
* [MDN: btoa()](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/btoa)